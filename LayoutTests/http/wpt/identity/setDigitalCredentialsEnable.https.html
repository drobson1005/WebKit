<!DOCTYPE html>
<html>
    <head>
        <title>
            Check that parts of the Digital Credentials API are not exposed by
            setting
        </title>
    </head>
    <script>
        testRunner.dumpAsText();
        testRunner.waitUntilDone();

        if (window.navigator.identity !== undefined) {
            console.log("FAIL: identity must not be exposed by default.");
        }

        if (window.DigitalCredential !== undefined) {
            console.log(
                "FAIL: DigitalCredential interface must not be exposed by default."
            );
        }

        // We check that the "digital" is not web exposed by checking if the
        // navigator.credentials.get() method rejects with an AbortError.
        const abortController = new AbortController();
        abortController.abort();
        const digitalTypeCheckPromise = navigator.credentials.get({
            digital: "", // expects a dictionary
            signal: abortController.signal,
        });

        window.internals.settings.setDigitalCredentialsEnabled(true);

        async function checkIFrame() {
            try {
                await digitalTypeCheckPromise;
            } catch (err) {
                if (err.name !== "AbortError") {
                    console.log(
                        `FAIL: navigator.credentials.get() must reject with an AbortError. Got ${err.name} instead.`
                    );
                }
            }

            const iframeWin = document.querySelector("iframe").contentWindow;

            if (iframeWin.navigator.credentials.requestIdentity) {
                console.log(
                    "FAIL: navigator.credentials.requestIdentity() was removed from the spec!"
                );
            }

            const { identity } = iframeWin.navigator;
            if (!identity) {
                console.log(
                    "FAIL: navigator.identity must be exposed. Was enabled by pref."
                );
            }

            try {
                await identity.get({ digital: "" });
            } catch (err) {
                if (err.name !== "TypeError") {
                    console.log(
                        `FAIL: navigator.identity.get() must reject with an TypeError. Got ${err.name} instead.`
                    );
                }
            }

            const isInstanceOfCredentialContainer =
                identity instanceof iframeWin.CredentialsContainer;
            if (!isInstanceOfCredentialContainer) {
                console.log(
                    "FAIL: navigator.identity must be and instance of CredentialsContainer."
                );
            }

            const isInstanceOfDigitalCredential =
                iframeWin.DigitalCredential.prototype instanceof
                iframeWin.Credential;
            if (!isInstanceOfDigitalCredential) {
                console.log(
                    "FAIL: DigitalCredential's prototype interface must be an instance of Credential."
                );
            }

            console.log("Test finished");
        }
    </script>
    <body>
        <iframe
            src="about:blank"
            onload="checkIFrame().catch(console.error).finally(() => testRunner.notifyDone())"
        ></iframe>
    </body>
</html>
